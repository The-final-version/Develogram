package com.goorm.clonestagram.like.service;

import java.util.Optional;

import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.goorm.clonestagram.exception.PostNotFoundException;
import com.goorm.clonestagram.like.domain.Like;
import com.goorm.clonestagram.like.repository.LikeRepository;
import com.goorm.clonestagram.post.domain.Posts;
import com.goorm.clonestagram.post.service.PostService;
import com.goorm.clonestagram.user.domain.Users;
import com.goorm.clonestagram.user.service.UserService;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class LikeService {
	private final LikeRepository likeRepository;
	private final UserService userService;
	private final PostService postService;

	// ì¢‹ì•„ìš” í† ê¸€
	@Transactional
	public void toggleLike(Long userId, Long postId) {
		Users user = userService.findByIdAndDeletedIsFalse(userId);
		// ğŸ”’ ì—¬ê¸°ì„œ ë¹„ê´€ì  ë½ (SELECT FOR UPDATE) â†’ ì´ ì‹œì ë¶€í„° ì§ë ¬ ì²˜ë¦¬
		Posts post = postService.findByIdWithPessimisticLock(postId);

		// userIdì™€ postIdë¥¼ ì‚¬ìš©í•´ ì¢‹ì•„ìš” ì—¬ë¶€ í™•ì¸
		// ë½ ê±¸ê³  ì¡°íšŒ
		Optional<Like> existingLike = likeRepository.findByUser_IdAndPost_Id(userId, postId);

		if (existingLike.isEmpty()) {
			try {
				likeRepository.save(new Like(user, post)); // ì¢‹ì•„ìš” ì¶”ê°€
			} catch (DataIntegrityViolationException e) {
				// ë™ì‹œì— ë‘ ìš”ì²­ì´ ì˜¨ ê²½ìš° í•˜ë‚˜ëŠ” ì„±ê³µí•˜ê³  í•˜ë‚˜ëŠ” ì´ê³³ìœ¼ë¡œ ì˜´.
				if (likeRepository.existsByUser_IdAndPost_Id(userId, postId)) {
					log.warn("ì¤‘ë³µ ì¢‹ì•„ìš” ìš”ì²­ ê°ì§€: userId={}, postId={}", userId, postId);
				} else
					throw e;
			}

		} else
			likeRepository.delete(existingLike.get());
		syncLikeCount(postId);
	}

	@Transactional
	public void syncLikeCount(Long postId) {
		Long count = likeRepository.countByPost_Id(postId);

		if (likeRepository.existsLikeCountByPostId(postId)) {
			likeRepository.updateLikeCount(postId, count);
		} else {
			likeRepository.saveLikeCount(postId, count);
		}
	}

	@Transactional(readOnly = true)
	public Long getLikeCount(Long postId) {
		if (!postService.existsByIdAndDeletedIsFalse(postId)) {
			throw new PostNotFoundException(postId);
		}

		// return likeRepository.countByPost_Id(postId);
		return likeRepository.findLikeCount(postId).orElse(0L);
	}

	public boolean isPostLikedByLoginUser(Long postId, Long userId) {
		Users user = userService.findByIdAndDeletedIsFalse(userId);
		Posts post = postService.findByIdAndDeletedIsFalse(postId);

		return likeRepository.existsByUser_IdAndPost_Id(userId, postId);
	}

}
